pipeline {
  agent { label "ec2-jnlp-slave" }
  options {
    disableConcurrentBuilds()
    quietPeriod(0)
    ansiColor('xterm')
  }
  parameters {
    booleanParam(defaultValue: true, name: 'DESTROY_AT_THE_START', description: 'Destroy the current environment at the start of the build')
    booleanParam(defaultValue: false, name: 'DEPLOY', description: 'Deploy the application to Amazon')
    booleanParam(defaultValue: false, name: 'RUN_TESTS', description: 'Run tests against the application')
    booleanParam(defaultValue: false, name: 'DESTROY_AT_THE_END', description: 'Destroy the environment at the end.')
  }
  environment {
    BUILD_TAG = resolveBuildTag()
    VPC_NAME = "macpro-dev"
    OIDC_CLIENT_ID = "0oa4juv4poiQ6nDB6297"
    OIDC_ISSUER = "https://test.idp.idm.cms.gov/oauth2/aus4itu0feyg3RJTK297"
    TF_VAR_openid_discovery_url = "https://test.idp.idm.cms.gov/oauth2/aus4itu0feyg3RJTK297/.well-known/openid-configuration"
  }
  stages {
    stage("Prep Agent") {
      steps {
        script {
          currentBuild.displayName = env.BUILD_TAG

          def jenkinsUtils = load ".jenkins/groovy/JenkinsUtils.groovy"
          jenkinsUtils.installAwsCli()
          jenkinsUtils.installEcsCli()
          jenkinsUtils.installTerraform("0.12.28")

          if( env.BUILD_NUMBER == "1" ) {
            env.DEPLOY = true
            env.RUN_TESTS = true
          }
        }
      }
    }

    stage("Destroy at the start") {
      when {
        expression { env.DESTROY_AT_THE_START == "true"}
      }
      steps {
        script {
          def jenkinsUtils = load ".jenkins/groovy/JenkinsUtils.groovy"
          dir('frontend/aws') {
            jenkinsUtils.terraformApply(env.APPLICATION_BUCKET, env.BRANCH_NAME, "destroy",
              [
                "application_version": env.BUILD_TAG,
                "vpc_name": env.VPC_NAME
              ]
            )
          }
          dir('data/aws') {
            jenkinsUtils.terraformApply(env.APPLICATION_BUCKET, env.BRANCH_NAME, "destroy",
              [
                "application_version": env.BUILD_TAG,
                "vpc_name": env.VPC_NAME
              ]
            )
          }
        }
      }
    }
  }
}

def resolveBuildTag() {
  return "${BRANCH_NAME}.${GIT_COMMIT}"
}
